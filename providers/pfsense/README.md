# external-dns for pfSense


## 功能

本服务的功能是，将与本服务同一个Environment中所有暴露端口的服务的IP注册到pfSense的dnsmasq中，从而可以实现将某个固定的Hostname和某个服务的（可能变化的）IP做绑定。

下面将会介绍如何（重新）构建一个镜像，以及如何将镜像部署到Rancher上。最后会有个troubleshooting。

## 构建

### 前置要求

在进行下面的步骤前，构建的机子的操作系统默认是Ubuntu，然后有装Docker，有装Go的工具链。

### 依赖管理

本项目用`trash`来管理依赖。一般的流程就是，在项目根目录下，往`vendor.conf`中加入需要的依赖的GitHub地址以及想要的commit对应的hash值，然后再在项目根目录下运行`trash`。

关于`trash`的更多信息看（https://github.com/rancher/trash ），这里介绍了怎么去安装`trash`。其中一种安装的方法，大概就是`go get -u github.com/rancher/trash `，然后在`$GOPATH/bin`下应该就能看到`trash`的可执行文件。这时候如果`$GOPATH/bin`在`$PATH`下，我们就能在项目根目录下直接运行`trash`了。

另外，如果不知道`$GOPATH`在哪里，可以通过`go env`查看。

### 手工构建

在修改完代码后想上线新版本，需要先build，打tag，push到registry，再在Rancher上的Catalog中拉下来。

#### 如何Build

在项目根目录下`sudo make`。

如果最后能够看到类似

```
Step 8/8 : ENTRYPOINT /usr/bin/rancher-entrypoint.sh
 ---> Running in bd70bd2f283a
 ---> 9a6b782b35dc
Removing intermediate container bd70bd2f283a
Successfully built 9a6b782b35dc
Successfully tagged rancher/external-dns:f915e7b
Built rancher/external-dns:f915e7b
INFO[0011] docker cp /go/src/github.com/rancher/external-dns/bin .
INFO[0011] docker cp /go/src/github.com/rancher/external-dns/dist .
```

的信息，那么就成功了。



#### 如何打tag

首先要找到刚build完后的输出信息中包含的形如`rancher/external-dns:xxxxxx`的字符串，它代表刚build完的镜像，比如上面这段例子中就是`rancher/external-dns:f915e7b`。冒号后面的就是默认的tag，它跟本项目在本地Git的最后一次commit的哈希值是一样的。值得一提的是，假如用户在本地最后一次commit的基础上，又修改了一下代码然后build，而修改的代码又没有commit，那么build完的镜像会形如`rancher/external-dns:xxxx-dirty`。

打tag的方法是，运行`sudo docker tag rancher/external-dns:xxxxxx  registry.bj.tusimple.ai:5043/service/external-dns:yyyyyy  `，其中`yyyyy`随意。 

#### 如何push到registry

在本机第一次push之前，需要先让本机Docker登录registry。具体做法是先下载证书（http://registry.bj.tusimple.ai:8080/static/cert/ca.crt ），然后再运行

```shell
mkdir -p /etc/docker/certs.d/registry.bj.tusimple.ai:5043/
cp /path/to/ca.crt /etc/docker/certs.d/registry.bj.tusimple.ai:5043/ca.crt
```

这时候可以登录了

```shell
docker login registry.bj.tusimple.ai:5043
```

成功的话应该能看到`Login Succeeded`。然后就可以对该registry进行push或者pull的操作了（当然我们这里只需要push）。

运行`sudo docker push registry.bj.tusimple.ai:5043/service/external-dns:yyyyyy`。



### Jenkins 中的CI

除了上面提到的手工构建的方式，我们在Jenkins中实现了了自动化上述流程的逻辑，可以通过登录Jenkins中查看`pfsenseExternalDNS-build`这个项目。每当一个新的commit被`git push`到GitHub上，就会触发到Jenkins的自动构建过程，然后Jenkins就会完成build、tag、push的步骤，其中的`yyyyyy`是和`xxxxx`是一样的，即最新的这个commit的哈希值。



## 部署

### ZooKeeper的设置

external-dns启动的时候会读入一次ZooKeeper上的配置，因此假如要修改配置，请重启external-dns。

1. 登录ZooKeeper管理界面

2. 在`external-dns-configuration`节点中，你需要设置以下键值对（key-value pair)：

   - `MYSQL_OPENPARAM`：登录MySQL的账号密码以及地址；
   - `PFSENSE_APIKEY`： pfSense FauxAPI 的 apikey；
   - `PFSENSE_APISECRET`：pfSense FauxAPI 的 apisecret；

3. 在`external-dns-whitelist`节点中，你需要设置被允许把DNS记录注册到pfSense的服务。key的格式是`<service_name>.<stack_name>.<environment_name>.<domain1>.`，value的格式是`<hostname>.<domain2>`。具体行为就是，只允许key所代表的服务被注册到pfSense中，而注册到DNS中的条目是`<value, IP>`。这里要注意：

   - key的最后须带一个`.`；
   - `<domain1>`是写在`docker-compose.yml`中，默认是`bj.tusimple.ai`；
   - `<hostname>`不能带有`.`，比如`webtest`就是一个合适的`<hostname>`，而`web.test`就不行；
   - `<domain2>`是写死进代码里的，就是`bj.tusimple.ai`；

   举个例子，当key为`webtest.default.default.bj.tusimple.ai.`，value为`webtest-zsh.bj.tusimple.ai`，具体的行为就是允许`default`环境中的`default`栈中的`webtest`服务被注册到pfSense的DNS中，而具体被注册的DNS条目则是`<webtest-zsh.bj.tusimple.ai,IP>`。

### MySQL的设置

登录指定的MySQL中，运行`TuSimple/infra-external-dns`下的`providers/pfsense/init.sql`，创建必须的数据库与表。

就我来说，这个可以用MySQL WorkBench来做，具体来说就是登录进MySQL之后，运行

```sql
create database externalDNS;
use externalDNS;
create table TxtRec(
	Dummy int primary key,
    Txt Text
);
```



### 部署到Rancher上

部署需要的`docker-compose.yml`和`rancher-compose`已经写好在Catalog里了，我们只需要直接导入即可。

首先我们需要在Rancher中加入我们infra的Catalog。在Rancher中，点击上面的CATALOG，点右边的Manage，增加一个catalog为`https://<username>:<password>@github.com/TuSimple/infra-rancher-catalog.git`，这个用户名密码是拥有`infra-rancher-catalog`这个GitHub Repository的拥有者的。

点击Save后，应该能在上面Catalog中，看到tusimple的，点进去后其中应该能看到external-dns，点开。在`Image Tag`中修改为push到registry里的镜像的tag，其实就是上边这个`yyyyyy`。然后Launch即可。



## 可能的问题
### 很多hostname无法解析，比如`zk`，`nas-web`等
按目前观察来看，有较小的可能dnsmasq服务无法正常重启，这时候需要人工手动重启该服务。尝试进入pfSense的网页管理界面，进入Services下的DNS Forwarder，在不影响其他配置的条件下修改一点东西（比如编辑一条Host Overrides再保存）。这时候网页应该会出现”Apply“的按钮，点击它，这时候DNS服务就会重启。

### external-dns容器日志中出现Hostname的解析问题（比如`zk`，`mysql` ），但外面的机器是可以解析的
检查是否将容器的DNS服务器设置为网关10.130.1.10。

### pfSense下的DNS Forwarder下的Host Overrides有冗余记录
这种情况是可能发生的，可能原因包括用户修改了ZooKeeper下的`external-dns-whitelist`已有条目的key，使得external-dns启动时不能找到pfSense下属于它管理的条目。但无论如何，注意到external-dns产生的DNS条目的Description都是”a Rancher/external-dns autogenerated record“，只要是这种记录，用户都是可以直接删的。

### 有时external-dns 无法正常启动，比如不断重启不断失败
先停止external-dns，然后清空一下MySQL的`externalDNS`数据库下的`TxtRec`表的所有内容。因为在某些时候，MySQL会存着暂时无法预知的奇怪数据，使得external-dns直接panic。清空的办法可以是，使用MySQL Workbench之类的数据库GUI管理工具，登录`mysql`下的MySQL（externalDNS/tusimple2017），然后
```SQL
use externalDNS;
drop table TxtRec; 
create table TxtRec(
	Dummy int primary key,
    Txt Text
);
select * from TxtRec;
```

然后再重启external-dns服务试试。